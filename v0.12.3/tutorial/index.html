<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · TestParticle.jl</title><meta name="title" content="Tutorial · TestParticle.jl"/><meta property="og:title" content="Tutorial · TestParticle.jl"/><meta property="twitter:title" content="Tutorial · TestParticle.jl"/><meta name="description" content="Documentation for TestParticle.jl."/><meta property="og:description" content="Documentation for TestParticle.jl."/><meta property="twitter:description" content="Documentation for TestParticle.jl."/><meta property="og:url" content="https://henry2004y.github.io/TestParticle.jl/tutorial/"/><meta property="twitter:url" content="https://henry2004y.github.io/TestParticle.jl/tutorial/"/><link rel="canonical" href="https://henry2004y.github.io/TestParticle.jl/tutorial/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">TestParticle.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Choice-of-numerical-algorithms"><span>Choice of numerical algorithms</span></a></li><li><a class="tocitem" href="#Unit-conversions"><span>Unit conversions</span></a></li><li><a class="tocitem" href="#Tracing-backwards-in-time"><span>Tracing backwards in time</span></a></li><li><a class="tocitem" href="#Multiple-particles-tracing"><span>Multiple particles tracing</span></a></li><li><a class="tocitem" href="#Guiding-center-drifts"><span>Guiding center drifts</span></a></li><li><a class="tocitem" href="#Adiabatic-Invariants"><span>Adiabatic Invariants</span></a></li><li><a class="tocitem" href="#Solution-Interpolations"><span>Solution Interpolations</span></a></li><li><a class="tocitem" href="#Presentations"><span>Presentations</span></a></li></ul></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../plotfunctions/">Plot Functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/henry2004y/TestParticle.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/henry2004y/TestParticle.jl/blob/master/docs/src/tutorial.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial"><a class="docs-heading-anchor" href="#Tutorial">Tutorial</a><a id="Tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial" title="Permalink"></a></h1><p>What makes plasmas particularly difficult to analyze is the fact that the densities fall in an intermediate range. Fluids like water are so dense that the motions of individual molecules do not have to be considered. Collisions dominate, and the simple equations of ordinary fluid dynamics suffice. At the other extreme in very low-density devices, only single-particle trajectories need to be considered; collective effects are often unimportant. Plasma behaves sometimes like fluids, and sometimes like a collection of individual particles. The first step in learning how to deal with this schizophrenic personality is to understand how single particles behave in electric and magnetic fields.</p><p>Here we assume that the EM fields are prescribed and not affected by the charged particles. References can be found in classic textbooks like <a href="https://link.springer.com/book/10.1007/978-3-319-22309-4">Introduction to Plasma Physics and Controlled Fusion</a> by F.F.Chen, and <a href="https://doi.org/10.1017/CBO9780511807183">Fundamentals of Plasma Physics</a> by Paul Bellan. For more complete notes corresponding to the derivation online, please check out <a href="https://henry2004y.github.io/KeyNotes/contents/single.html">Single-Particle Motions</a>.</p><h2 id="Choice-of-numerical-algorithms"><a class="docs-heading-anchor" href="#Choice-of-numerical-algorithms">Choice of numerical algorithms</a><a id="Choice-of-numerical-algorithms-1"></a><a class="docs-heading-anchor-permalink" href="#Choice-of-numerical-algorithms" title="Permalink"></a></h2><p>By default DifferentialEquations.jl applies <code>Tsit5</code> to an ODE problem. If only OrdinaryDiffEq.jl is imported, then we need to explicitly select a solver. However, not all solvers are guaranteed to work. For example, the demo case of electron tracing in the magnetic bottle with strong magnetic field is tested to work only with fixed timestep algorithms like <code>Euler</code> and the Adams-Bashforth family.</p><p>Currently we recommend <code>Vern9</code> as a starting point for adaptive timestepping, with additional fine tuning by changing <code>reltol</code> if needed. You can also try out the native implementation of the Boris method in TestParticle.jl, with a constraint of using a fixed time step.</p><p>Take you some time to figure out which algorithm works for your problem!</p><h2 id="Unit-conversions"><a class="docs-heading-anchor" href="#Unit-conversions">Unit conversions</a><a id="Unit-conversions-1"></a><a class="docs-heading-anchor-permalink" href="#Unit-conversions" title="Permalink"></a></h2><p>By default SI units are applied within the package. However, users can also define their own units by setting the particle mass and charge (2 constants) and providing the basic scales of magnetic field, length, time, or velocity (3 reference scales required; length, time and velocity are interchangable).</p><p>In the dimensionless natural unit system, we have the most number of ones which in turn gives the simplest form for computation. Check out the demos on unit conversions for more details.</p><h2 id="Tracing-backwards-in-time"><a class="docs-heading-anchor" href="#Tracing-backwards-in-time">Tracing backwards in time</a><a id="Tracing-backwards-in-time-1"></a><a class="docs-heading-anchor-permalink" href="#Tracing-backwards-in-time" title="Permalink"></a></h2><p>It is easy to trace a charged particle backwards in time. In a forward tracing problem, we set <code>tspan = (t1, t2)</code> where <code>t1 &lt; t2</code>. In a backward tracing problem, we simply set <code>t1 &gt; t2</code>, e.g. <code>tspan = (0.0, -1.0)</code>. Note that tracing backwards in time is different from inversing the velocity because of the cross product in the Lorentz force. More specifically, the drift velocities will not change sign if one inverses velocity.</p><h2 id="Multiple-particles-tracing"><a class="docs-heading-anchor" href="#Multiple-particles-tracing">Multiple particles tracing</a><a id="Multiple-particles-tracing-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-particles-tracing" title="Permalink"></a></h2><p>There are two ways to trace multiple particles simultaneously:</p><ol><li>Extracting the solution in a loop with varying initial conditions. See the example <a href="../examples/advanced/demo_ensemble/#demo_ensemble">demo_ensemble</a>.</li><li>Constructing the <a href="https://diffeq.sciml.ai/stable/features/ensemble/">Ensemble Simulations</a>. One example can be found <a href="https://github.com/henry2004y/TestParticle.jl/tree/master/examples/demo_ensemble.jl">here</a>. However, note that by default the ensemble type replicates the parameters for each solution, which is very memory inefficient for tracing in a numeric field. We need to set <code>safetycopy=false</code> to make the field as a reference in the parameter of each trajectory.</li></ol><p>The Boris pusher follows a similar interface for multithreading.</p><h2 id="Guiding-center-drifts"><a class="docs-heading-anchor" href="#Guiding-center-drifts">Guiding center drifts</a><a id="Guiding-center-drifts-1"></a><a class="docs-heading-anchor-permalink" href="#Guiding-center-drifts" title="Permalink"></a></h2><p>By solving the trajectories of particles, we can calculate the actual guiding center orbits by following the definition. This is supported directly via <code>get_gc</code>. In theoretical treatments, all kinds of drifts have been derived with analytical formulas listed below (see <code>trace_gc_drifts!</code>). With additional ODEs for solving the drifts, we can separate the different effects or check the deviation of actual orbits from the low order analytical formulas.</p><p>An alternative approach is to solve the guiding center approximation equations. In TestParticle.jl, we provide tracing via solving the equations derived from Hamiltonian mechanics and their 1st order approximation.</p><h3 id="Summary-of-guiding-center-drifts"><a class="docs-heading-anchor" href="#Summary-of-guiding-center-drifts">Summary of guiding center drifts</a><a id="Summary-of-guiding-center-drifts-1"></a><a class="docs-heading-anchor-permalink" href="#Summary-of-guiding-center-drifts" title="Permalink"></a></h3><p>General force:</p><p class="math-container">\[\mathbf{v}_f = \frac{1}{q}\frac{\mathbf{F}\times\mathbf{B}}{B^2}\]</p><p>Electric field:</p><p class="math-container">\[\mathbf{v}_E = \frac{\mathbf{E}\times\mathbf{B}}{B^2}\]</p><p>Gravitational field:</p><p class="math-container">\[\mathbf{v}_g = \frac{m}{q}\frac{\mathbf{g}\times\mathbf{B}}{B^2}\]</p><p>Nonuniform electric field:</p><p class="math-container">\[\mathbf{v}_E = \Big( 1+\frac{1}{4}r_L^2 \nabla^2 \Big)\frac{\mathbf{E}\times\mathbf{B}}{B^2}\]</p><p>Nonuniform magnetic field:</p><p>Grad-B:</p><p class="math-container">\[\begin{aligned}
\mathbf{v}_{\nabla B} &amp;= \pm \frac{1}{2}v_\perp r_L\frac{\mathbf{B}\times\nabla B}{B^2} \\
&amp;=\frac{mv_\perp^2}{2qB^3}\mathbf{B}\times\nabla B
\end{aligned}\]</p><p>Curvature drift:</p><p class="math-container">\[\begin{aligned}
\mathbf{v}_c &amp;= \frac{mv_\parallel^2}{q}\frac{\mathbf{R}_c \times\mathbf{B}}{R_c^2 B^2} \\
&amp;= \frac{mv_\parallel^2}{qB^4}\mathbf{B}\times\left[ \mathbf{B}\cdot\nabla\mathbf{B} \right] \\
&amp;= \frac{m v_\parallel^2}{qB^3}\mathbf{B}\times\nabla B\,\text{(current-free)}
\end{aligned}\]</p><p>Curved vacuum field:</p><p class="math-container">\[\begin{aligned}
\mathbf{v}_c + \mathbf{v}_{\nabla B} &amp;= \frac{m}{q}\Big( v_\parallel^2 + \frac{1}{2}v_\perp^2 \Big) \frac{\mathbf{R}_c \times\mathbf{B}}{R_c^2 B^2} \\
&amp;= \frac{m}{q}\frac{\mathbf{B}\times\nabla B}{B^3}\Big( v_\parallel^2 + \frac{1}{2}v_\perp^2 \Big)
\end{aligned}\]</p><p>Polarization drift:<sup class="footnote-reference"><a id="citeref-2" href="#footnote-2">[2]</a></sup></p><p class="math-container">\[\mathbf{v}_p = \pm \frac{1}{\omega_c B}\frac{d\mathbf{E}}{dt}\]</p><h2 id="Adiabatic-Invariants"><a class="docs-heading-anchor" href="#Adiabatic-Invariants">Adiabatic Invariants</a><a id="Adiabatic-Invariants-1"></a><a class="docs-heading-anchor-permalink" href="#Adiabatic-Invariants" title="Permalink"></a></h2><p>See more thorough <a href="https://henry2004y.github.io/KeyNotes/contents/single.html#sec-adiabatic-invariant">notes</a> on the adiabatic invariants.</p><h2 id="Solution-Interpolations"><a class="docs-heading-anchor" href="#Solution-Interpolations">Solution Interpolations</a><a id="Solution-Interpolations-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-Interpolations" title="Permalink"></a></h2><p>All the tracing solutions come with an interpolation method to make them continuous. Depending on the order of the scheme, different orders of interpolations are applied.</p><p>Note that if the scheme comes with an &quot;lazy&quot; interpolation (e.g. Vern family), you can either output the full solution (default) and interpolate</p><pre><code class="language-julia hljs">sol = solve(prob, Vern9())</code></pre><p>or turn off the lazy interpolation and select part of the solution</p><pre><code class="language-julia hljs">sol = solve(prob, Vern9(lazy=false), save_idxs=[1,2,3])</code></pre><p>The interpolated solution would be wrong if <code>lazy=true</code> and <code>save_idxs!=[1,2,3,4,5,6]</code>.</p><h2 id="Presentations"><a class="docs-heading-anchor" href="#Presentations">Presentations</a><a id="Presentations-1"></a><a class="docs-heading-anchor-permalink" href="#Presentations" title="Permalink"></a></h2><p>Please checkout:</p><ul><li><a href="https://henry2004y.github.io/pluto_playground/testparticle_202401.html">TestParticle.jl: A New Tool for An Old Problem</a></li><li><a href="https://henry2004y.github.io/pluto_playground/testparticle_202212.html">基于开源工具链的测试粒子模型</a></li></ul><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-2"><a class="tag is-link" href="#citeref-2">2</a>In common test particle models, we assume static EM fields, so the polarization drift as well as adiabatic heating is not present. However, it is easily achieveable here in this package.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../examples/">Examples »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.1 on <span class="colophon-date" title="Thursday 24 April 2025 04:45">Thursday 24 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
