<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cosmic Ray Tracing · TestParticle.jl</title><meta name="title" content="Cosmic Ray Tracing · TestParticle.jl"/><meta property="og:title" content="Cosmic Ray Tracing · TestParticle.jl"/><meta property="twitter:title" content="Cosmic Ray Tracing · TestParticle.jl"/><meta name="description" content="Documentation for TestParticle.jl."/><meta property="og:description" content="Documentation for TestParticle.jl."/><meta property="twitter:description" content="Documentation for TestParticle.jl."/><meta property="og:url" content="https://henry2004y.github.io/TestParticle.jl/examples/advanced/demo_cosmicray/"/><meta property="twitter:url" content="https://henry2004y.github.io/TestParticle.jl/examples/advanced/demo_cosmicray/"/><link rel="canonical" href="https://henry2004y.github.io/TestParticle.jl/examples/advanced/demo_cosmicray/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">TestParticle.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../">Examples</a></li><li><a class="tocitem" href="../../../api/">API</a></li><li><a class="tocitem" href="../../../plotfunctions/">Plot Functions</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Cosmic Ray Tracing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cosmic Ray Tracing</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/henry2004y/TestParticle.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/henry2004y/TestParticle.jl/blob/master/docs/examples/advanced/demo_cosmicray.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="demo_cosmic_ray"><a class="docs-heading-anchor" href="#demo_cosmic_ray">Cosmic Ray Tracing</a><a id="demo_cosmic_ray-1"></a><a class="docs-heading-anchor-permalink" href="#demo_cosmic_ray" title="Permalink"></a></h1><p><a href="../demo_cosmicray.jl"><img src="https://img.shields.io/badge/download-julia-brightgreen.svg" alt="Source code"/></a> <img src="https://img.shields.io/badge/julia-1.11.4-blue.svg" alt="compat"/> <a href="https://github.com/henry2004y"><img src="https://img.shields.io/badge/Author-Hongyang%20Zhou-blue" alt="Author"/></a> <img src="https://img.shields.io/date/1742342400" alt="Update time"/></p><p>This example shows how to trace cosmic rays in a background magnetic field. In practice, at least in the interstellar medium, the effect of the electric field over high-energy (multi TeV) cosmic rays can be neglected. Therefore, energy is conserved and we are interested in looking at the scattering and diffusion processes. In this demo, we are following the normalization procedures in <a href="https://iopscience.iop.org/article/10.1088/0004-637X/728/1/60">Numerical Study of Cosmic Ray Diffusion in MHD Turbulence</a>. The Lorentz equation for each particle of charge <span>$q$</span> and mass <span>$m$</span>. The particle has a momentum <span>$\mathbf{p} = \gamma m \mathbf{v}$</span> and a normalized velocity <span>$\mathbf{v}_c = \mathbf{v} / c$</span> and propagates in an electromagnetic field <span>$\mathbf{E}$</span> (no mean electric field), <span>$\mathbf{B} = \delta \mathbf{B} + \mathbf{B}_0$</span>:</p><p class="math-container">\[\begin{aligned}
\frac{\mathrm{d}\mathbf{p}}{\mathrm{d} t} &amp;= q (\mathbf{E} + \mathbf{v}_c times \mathbf{B}) \\
\frac{\mathrm{d}\mathbf{x}}{\mathrm{d} t} &amp;= \mathbf{v}
\end{aligned}\]</p><p>Each particle is injected with a Lorentz factor <span>$\gamma_0$</span>. Physically, one can think of <span>$gamma_0$</span> as a measure of the relativity of the particle, i.e., for small <span>$gamma_0$</span> we will recover nonrelativistic equations, and for large <span>$gamma_0$</span> –- ultra-relativistic equations. <span>$\gamma_0$</span> also defines the initial Larmor radius</p><p class="math-container">\[r_{L0} = \gamma_0 m c^2 / (e B_0)\]</p><p>where <span>$B_0$</span> is background magnetic field strength. After normalization, we have</p><p class="math-container">\[\begin{aligned}
\frac{\mathrm{d}\mathbf{v}^\prime}{\mathrm{d} t^\prime} &amp;= \gamma^\prime \mathbf{E}^\prime + \mathbf{v}^\prime \times \mathbf{B}^\prime \\
\frac{\mathrm{d}\mathbf{x}^\prime}{\mathrm{d} t^\prime} &amp;= \mathbf{v}^\prime
\end{aligned}\]</p><p>where <span>$\mathbf{v}^\prime$</span> is the normalized space component of the 4-velocity <span>$(\gamma c, \gamma \mathbf{v}), \mathbf{v}^\prime = \mathbf{v} / \gamma_0$</span>, and <span>$\mathbf{x}^\prime = \mathbf{x} / r_{L0}$</span> is the normalized location, <span>$\mathbf{E}^\prime = \mathbf{E} / (c B_0)$</span> is the normalized electric field, and <span>$\mathbf{B}^\prime = \mathbf{B} / B_0$</span> is the normalized magnetic field. <span>$t^\prime = e B_0 / (m c^2) t$ is self-time measured in cyclotron frequency units. A particle with pitch angle cosine$</span>mu = 0<span>$will make a full orbit in the$</span>B_0<span>$field in$</span>2 \pi`` time.</p><p class="math-container">\[\gamma^\prime = \sqrt{\frac{1}{\gamma_0^2} + {\mathbf{u}^\prime}^2}\]</p><p>Most of the time, <span>$1 / \gamma_0 \rightarrow 0$</span> since cosmic rays are of high energy.</p><p>Let us first look at a simpler case without the electric field:</p><p class="math-container">\[\begin{aligned}
\frac{\mathrm{d}\mathbf{v}^\prime}{\mathrm{d} t^\prime} &amp;= \mathbf{v}^\prime \times \mathbf{B}^\prime \\
\frac{\mathrm{d}\mathbf{x}^\prime}{\mathrm{d} t^\prime} &amp;= \mathbf{v}^\prime
\end{aligned}\]</p><p>This is simply the normalized Lorentz equation. By taking <span>$q=1, m=1$</span>,</p><p class="math-container">\[\begin{aligned}
r_{L0} = \gamma_0 / B_0 \\
\Omega_0 = 1 / r_{L0}
\end{aligned}\]</p><p>In the original MHD solution, the length scale is also dimensionless. There, the ratio between the initial Larmor radius <span>$r_{L0}$</span> and the simulation box scale length <span>$L$</span> becomes important, as this determines how many discrete points are involved within a gyroradius. The smaller <span>$r_{L0} / L$</span> is, the more likely a particle will experience an inhomogeneous magnetic field during gyration, and the more likely it will get scattered.</p><p>Now let&#39;s demonstrate this with <code>trace_normalized!</code>.</p><pre><code class="language-julia hljs">using TestParticle
using OrdinaryDiffEq
using CairoMakie

# Number of cells for the field along each dimension
nx, ny, nz = 4, 6, 2
# Unit conversion factors between dimensional and dimensionless units
γ0 = 10.0
B0 = 10.0
rL0 = γ0 / B0
L = rL0 * 4.0
Ω0 = 1 / rL0
# All quantities are in dimensionless units
x = range(-L/2-0.01, L/2+0.01, length=nx) # [Ω0]
y = range(-L-0.01, 0.01, length=ny) # [Ω0]
z = range(-10, 10, length=nz) # [Ω0]

B = fill(0.0, 3, nx, ny, nz) # [B0]
B[3,:,:,:] .= 1.0
E = fill(0.0, 3, nx, ny, nz) # [E₀]

param = prepare(x, y, z, E, B; species=User)

# Initial condition
stateinit = let
   x0 = [0.0, 0.0, 0.0] # initial position [l₀]
   u0 = [2.0, 0.0, 0.0] # initial velocity [v₀] -&gt; r = 2 * rL0
   [x0..., u0...]
end
# Time span
tspan = (0.0, π) # half gyroperiod

prob = ODEProblem(trace_normalized!, stateinit, tspan, param)
sol = solve(prob, Vern9())

### Visualization
f = Figure(fontsize = 18)
ax = Axis(f[1, 1],
   title = &quot;Proton trajectory&quot;,
   xlabel = &quot;X&quot;,
   ylabel = &quot;Y&quot;,
   limits = (-2.1, 2.1, -4.1, 0.1),
   aspect = DataAspect()
)

lines!(ax, sol, idxs=(1,2))

xgrid = [i for i in x, _ in y]
ygrid = [j for _ in x, j in y]
scatter!(ax, xgrid[:], ygrid[:], color=:tomato)
</code></pre><p><img src="../demo_cosmicray-6.png" alt/></p><hr/><p><em>This page was generated using <a href="https://github.com/JuliaDocs/DemoCards.jl">DemoCards.jl</a> and <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Wednesday 19 March 2025 22:55">Wednesday 19 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
